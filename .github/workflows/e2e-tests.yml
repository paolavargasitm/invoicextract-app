name: E2E Tests with Cucumber & Playwright

on:
  push:
    branches: [ main, develop, feature/github-actions-workflows ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FRONTEND_URL: http://localhost:3001
  BACKEND_URL: http://localhost:8080/invoicextract
  DB_ADMIN_URL: http://localhost:8081
  KEYCLOAK_URL: http://localhost:8085

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create .env file if needed
        run: |
          touch .env

      - name: Build backend JAR before Docker compose
        run: |
          cd invoicextract-backend
          docker run --rm \
            -v $PWD:/app \
            -w /app \
            maven:3.9.6-eclipse-temurin-17 \
            mvn clean package -DskipTests
          cd ..

      - name: Build mapping-service JAR before Docker compose
        run: |
          cd invoicextract-mapping-service
          docker run --rm \
            -v $PWD:/app \
            -w /app \
            maven:3.9.6-eclipse-temurin-17 \
            mvn clean package -DskipTests
          cd ..

      - name: Build backend Docker image with latest code
        run: |
          if docker compose version &>/dev/null; then
            docker compose build app --no-cache
            docker compose build mapping-service --no-cache
          else
            docker-compose build app --no-cache
            docker-compose build mapping-service --no-cache
          fi

      - name: Start all services with Docker Compose
        run: |
          echo "Starting infrastructure services..."
          if docker compose version &>/dev/null; then
            docker compose up -d mysql mysql-mappings keycloak-db keycloak kafka
          else
            docker-compose up -d mysql mysql-mappings keycloak-db keycloak kafka
          fi
          
          echo "Waiting for infrastructure to be healthy..."
          sleep 60

      - name: Import Keycloak realm configuration
        run: |
          chmod +x .github/scripts/import-keycloak-realm.sh
          .github/scripts/import-keycloak-realm.sh

      - name: Check infrastructure health
        run: |
          echo "=== Checking MySQL ==="
          if docker compose version &>/dev/null; then
            docker compose ps mysql
          else
            docker-compose ps mysql
          fi
          
          echo "=== Checking Keycloak ==="
          if docker compose version &>/dev/null; then
            docker compose ps keycloak
          else
            docker-compose ps keycloak
          fi
          
          echo "=== Checking Kafka ==="
          if docker compose version &>/dev/null; then
            docker compose ps kafka
          else
            docker-compose ps kafka
          fi
          
          # Verify Keycloak is responding
          timeout 60 bash -c 'until curl -sf http://localhost:8085/realms/master/.well-known/openid-configuration > /dev/null; do echo "Waiting for Keycloak..."; sleep 5; done'
          echo "Keycloak is ready!"

      - name: Run Liquibase migrations
        run: |
          if docker compose version &>/dev/null; then
            docker compose up liquibase liquibase-mappings
          else
            docker-compose up liquibase liquibase-mappings
          fi
          
          echo "=== Liquibase invoices logs ==="
          if docker compose version &>/dev/null; then
            docker compose logs liquibase
          else
            docker-compose logs liquibase
          fi
          
          echo "=== Liquibase mappings logs ==="
          if docker compose version &>/dev/null; then
            docker compose logs liquibase-mappings
          else
            docker-compose logs liquibase-mappings
          fi

      - name: Start application services
        run: |
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "Starting backend application..."
          $COMPOSE_CMD up -d app
          
          echo "Starting mapping service..."
          $COMPOSE_CMD up -d mapping-service
          
          echo "Starting Adminer (Database Admin)..."
          $COMPOSE_CMD up -d adminer
          
          echo "Starting frontend..."
          $COMPOSE_CMD up -d frontend-new
          
          echo "Waiting for services to initialize..."
          sleep 45

      - name: Verify all services are accessible
        run: |
          echo "=== Service Status ==="
          if docker compose version &>/dev/null; then
            docker compose ps
          else
            docker-compose ps
          fi
          
          echo ""
          echo "=== Checking Backend Logs ==="
          docker logs invoicextract-app --tail=50
          
          echo ""
          echo "=== Testing URL: Frontend (${{ env.FRONTEND_URL }}) ==="
          timeout 120 bash -c 'until curl -sf ${{ env.FRONTEND_URL }} > /dev/null; do echo "Waiting for frontend..."; sleep 3; done'
          curl -I ${{ env.FRONTEND_URL }}
          echo "âœ… Frontend is accessible!"
          
          echo ""
          echo "=== Testing URL: Database Admin (${{ env.DB_ADMIN_URL }}) ==="
          timeout 60 bash -c 'until curl -sf ${{ env.DB_ADMIN_URL }} > /dev/null; do echo "Waiting for DB admin..."; sleep 3; done'
          curl -I ${{ env.DB_ADMIN_URL }}
          echo "âœ… Database Admin is accessible!"
          
          echo ""
          echo "=== Testing URL: Backend API (${{ env.BACKEND_URL }}) ==="
          timeout 180 bash -c 'until curl -sf ${{ env.BACKEND_URL }}/actuator/health > /dev/null; do echo "Waiting for backend..."; sleep 5; done'
          curl ${{ env.BACKEND_URL }}/actuator/health | jq . || curl ${{ env.BACKEND_URL }}/actuator/health
          echo "âœ… Backend API is accessible!"
          
          echo ""
          echo "=== Testing URL: Keycloak (${{ env.KEYCLOAK_URL }}) ==="
          curl -I ${{ env.KEYCLOAK_URL }}/realms/invoicextract/.well-known/openid-configuration
          echo "âœ… Keycloak is accessible!"

      - name: Seed initial test data
        run: |
          echo "=== Seeding initial ERP test data ==="
          
          # Wait for mapping-service to be ready (try swagger-ui endpoint)
          echo "Waiting for mapping-service to be healthy..."
          timeout 90 bash -c 'until curl -sf http://localhost:8082/invoice-mapping/swagger-ui.html > /dev/null 2>&1 || curl -sf http://localhost:8082/invoice-mapping/ > /dev/null 2>&1; do echo "Waiting for mapping-service..."; sleep 5; done' || echo "âš ï¸ mapping-service health check timed out, continuing anyway"
          echo "âœ… Mapping-service should be ready"
          
          # Get access token using localhost (issuer validation is now disabled in backend)
          echo "Getting access token from Keycloak..."
          TOKEN=$(curl -s -X POST "http://localhost:8085/realms/invoicextract/protocol/openid-connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=invoices-backend" \
            -d "client_secret=TlPOfnP8P30SdR6bRl3WtJSNqM6ojdhA" \
            -d "grant_type=client_credentials" | jq -r '.access_token')
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âŒ Failed to get access token for seeding"
            echo "Trying to get more details..."
            curl -v -X POST "http://localhost:8085/realms/invoicextract/protocol/openid-connect/token" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "client_id=invoices-backend" \
              -d "client_secret=TlPOfnP8P30SdR6bRl3WtJSNqM6ojdhA" \
              -d "grant_type=client_credentials"
            exit 1
          fi
          
          echo "âœ… Got access token for seeding"
          
          # Create initial ERPs via mapping-service API (context-path: /invoice-mapping)
          echo "Creating SAP ERP..."
          RESPONSE=$(curl -s -X POST "http://localhost:8082/invoice-mapping/api/erps" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "SAP", "active": true}' \
            -w "\n%{http_code}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "Response: $RESPONSE"
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "409" ]; then
            echo "âœ… SAP ERP created or already exists"
          else
            echo "âš ï¸ Unexpected status code: $HTTP_CODE"
          fi
          
          echo "Creating Oracle ERP..."
          RESPONSE=$(curl -s -X POST "http://localhost:8082/invoice-mapping/api/erps" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "Oracle ERP", "active": true}' \
            -w "\n%{http_code}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "Response: $RESPONSE"
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "409" ]; then
            echo "âœ… Oracle ERP created or already exists"
          else
            echo "âš ï¸ Unexpected status code: $HTTP_CODE"
          fi
          
          echo "Creating Microsoft Dynamics ERP..."
          RESPONSE=$(curl -s -X POST "http://localhost:8082/invoice-mapping/api/erps" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "Microsoft Dynamics", "active": false}' \
            -w "\n%{http_code}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "Response: $RESPONSE"
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "409" ]; then
            echo "âœ… Microsoft Dynamics ERP created or already exists"
          else
            echo "âš ï¸ Unexpected status code: $HTTP_CODE"
          fi
          
          echo "âœ… Test data seeding completed"

      - name: Install dependencies and Playwright browsers
        working-directory: ./invoicextract-automation/invoicextract
        run: |
          npm install
          npx playwright install --with-deps chromium

      - name: Create .env file for tests
        working-directory: ./invoicextract-automation/invoicextract
        run: |
          # Use secret if available, otherwise use default from realm
          CLIENT_SECRET="${{ secrets.KEYCLOAK_CLIENT_SECRET }}"
          if [ -z "$CLIENT_SECRET" ]; then
            CLIENT_SECRET="TlPOfnP8P30SdR6bRl3WtJSNqM6ojdhA"
          fi
          
          cat > .env << EOF
          # Base URLs
          BASE_URL=http://localhost:3001
          FRONTEND_URL=http://localhost:3001
          KEYCLOAK_BASE_URL=http://localhost:8085
          API_BASE_URL=http://localhost:8080/invoicextract
          
          # Browser Configuration
          HEADLESS=true
          SLOW_MO=0
          
          # Test Configuration
          TIMEOUT=60000
          PARALLEL_WORKERS=1
          
          # API Configuration
          API_TIMEOUT=30000
          
          # Keycloak Client Credentials for API Authentication
          CLIENT_ID=invoices-backend
          CLIENT_SECRET=${CLIENT_SECRET}
          
          # Test Credentials by Role
          ADMIN_USERNAME=ana.admin
          ADMIN_PASSWORD=ana.admin
          
          FINANCE_USERNAME=diego.finanzas
          FINANCE_PASSWORD=diego.finanzas
          
          TECHNICIAN_USERNAME=luis.tecnico
          TECHNICIAN_PASSWORD=luis.tecnico
          EOF
          
          echo "âœ… .env file created with test configuration"
          echo "CLIENT_ID: invoices-backend"
          echo "CLIENT_SECRET: [HIDDEN]"

      - name: Run Cucumber tests
        working-directory: ./invoicextract-automation/invoicextract
        env:
          BASE_URL: ${{ env.FRONTEND_URL }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
          API_BASE_URL: ${{ env.BACKEND_URL }}
          DB_ADMIN_URL: ${{ env.DB_ADMIN_URL }}
          KEYCLOAK_URL: ${{ env.KEYCLOAK_URL }}
          KEYCLOAK_BASE_URL: ${{ env.KEYCLOAK_URL }}
          HEADLESS: true
        run: |
          npm test
        continue-on-error: false

      - name: Generate test report
        if: always()
        working-directory: ./invoicextract-automation/invoicextract
        run: |
          npm run report || echo "Report generation completed with warnings"

      - name: Upload Cucumber HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-report-${{ github.sha }}
          path: |
            invoicextract-automation/invoicextract/reports/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ github.sha }}
          path: |
            invoicextract-automation/invoicextract/reports/
            invoicextract-automation/invoicextract/test-results/
          retention-days: 14

      - name: Show service logs on failure
        if: failure()
        run: |
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "=== Frontend Logs ==="
          $COMPOSE_CMD logs frontend-new | tail -100 || echo "Frontend logs not available"
          echo ""
          echo "=== Backend Logs ==="
          $COMPOSE_CMD logs app | tail -100 || echo "Backend logs not available"
          echo ""
          echo "=== MySQL Logs ==="
          $COMPOSE_CMD logs mysql | tail -50 || echo "MySQL logs not available"
          echo ""
          echo "=== Keycloak Logs ==="
          $COMPOSE_CMD logs keycloak | tail -50 || echo "Keycloak logs not available"

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ¥’ Cucumber E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŒ Environment URLs Tested" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend: ${{ env.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database Admin: ${{ env.DB_ADMIN_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend API: ${{ env.BACKEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Keycloak: ${{ env.KEYCLOAK_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ³ Services Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker compose ps 2>/dev/null || echo "Services information not available" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -d "invoicextract-automation/invoicextract/reports" ]; then
            echo "- ðŸ“ Cucumber HTML reports generated" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ Test reports available in artifacts" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¦ Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Cucumber HTML Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ Test Results (JSON)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¸ Screenshots (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¬ Videos (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ§ª Test Framework" >> $GITHUB_STEP_SUMMARY
          echo "- Framework: Cucumber.js + Playwright" >> $GITHUB_STEP_SUMMARY
          echo "- Location: \`invoicextract-automation/invoicextract/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Features: BDD scenarios with Gherkin syntax" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          if docker compose version &>/dev/null; then
            docker compose down -v || true
          else
            docker-compose down -v || true
          fi
          docker system prune -f || true
